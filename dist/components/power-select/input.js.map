{"version":3,"file":"input.js","sources":["../../../src/components/power-select/input.gts"],"sourcesContent":["import Component from '@glimmer/component';\nimport { action } from '@ember/object';\nimport { modifier } from 'ember-modifier';\nimport { assert } from '@ember/debug';\nimport { get } from '@ember/object';\nimport { task, timeout } from 'ember-concurrency';\nimport { on } from '@ember/modifier';\nimport { or } from 'ember-truth-helpers';\nimport type { ComponentLike } from '@glint/template';\nimport type { PowerSelectPlaceholderSignature } from './placeholder.gts';\nimport type { Select, Selected, TSearchFieldPosition } from '../../types';\nimport type { PowerSelectArgs } from '../power-select.gts';\n\nexport interface PowerSelectInputSignature<\n  T = unknown,\n  TExtra = unknown,\n  IsMultiple extends boolean = false,\n> {\n  Element: HTMLInputElement;\n  Args: {\n    select: Select<T, IsMultiple>;\n    ariaLabel?: string;\n    ariaLabelledBy?: string;\n    ariaDescribedBy?: string;\n    role?: string;\n    searchField?: string;\n    searchPlaceholder?: string;\n    searchFieldPosition?: TSearchFieldPosition;\n    ariaActiveDescendant?: string;\n    isDefaultPlaceholder?: boolean;\n    listboxId?: string;\n    autofocus?: boolean;\n    tabindex?: number | string;\n    extra?: TExtra;\n    placeholderComponent?: ComponentLike<\n      PowerSelectPlaceholderSignature<T, TExtra, IsMultiple>\n    >;\n    onKeydown?: (e: KeyboardEvent) => boolean | void;\n    onBlur?: (e: FocusEvent) => void;\n    onFocus?: (e: FocusEvent) => void;\n    onInput?: (e: InputEvent) => void | boolean;\n    buildSelection?: PowerSelectArgs<T, IsMultiple, TExtra>['buildSelection'];\n  };\n}\n\nexport default class PowerSelectInput<\n  T = unknown,\n  TExtra = unknown,\n  IsMultiple extends boolean = false,\n> extends Component<PowerSelectInputSignature<T, TExtra, IsMultiple>> {\n  didSetup: boolean = false;\n\n  private _lastIsOpen: boolean = this.args.select.isOpen;\n\n  get placeholder() {\n    if (!this.args.isDefaultPlaceholder) {\n      return undefined;\n    }\n\n    if (this.args.select.multiple) {\n      return !this.args.select.selected ||\n        (Array.isArray(this.args.select.selected) &&\n          this.args.select.selected.length === 0)\n        ? this.args.searchPlaceholder || ''\n        : '';\n    }\n\n    return this.args.searchPlaceholder;\n  }\n\n  @action\n  handleKeydown(e: KeyboardEvent): false | void {\n    if (e.target === null) return;\n    if (this.args.onKeydown && this.args.onKeydown(e) === false) {\n      e.stopPropagation();\n      return false;\n    }\n    if (this.args.select.multiple) {\n      if (e.key === 'Backspace') {\n        e.stopPropagation();\n        if (\n          !(e.target as HTMLInputElement).value.trim() &&\n          this.args.buildSelection &&\n          Array.isArray(this.args.select.selected)\n        ) {\n          const selected = this.args.select.selected as Selected<T, true>;\n          const lastSelection = selected[selected.length - 1];\n\n          if (lastSelection) {\n            this.args.select.actions.select(\n              this.args.buildSelection(lastSelection, this.args.select),\n              e,\n            );\n            if (typeof lastSelection === 'string') {\n              this.args.select.actions.search(lastSelection);\n            } else {\n              assert(\n                '`<PowerSelect>` requires a `@searchField` when the options are not strings to remove options using backspace',\n                this.args.searchField,\n              );\n              this.args.select.actions.search(\n                (get(lastSelection, this.args.searchField) || '') as string,\n              );\n            }\n            this.args.select.actions.open(e);\n          }\n        }\n      } else if (e.key.length === 1 && /[a-z0-9 ]/i.test(e.key)) {\n        // Keys 0-9, a-z or SPACE\n        e.stopPropagation();\n      }\n    } else if (e.key === 'Enter') {\n      this.args.select.actions.close(e);\n    }\n  }\n\n  @action\n  handleInput(event: Event): false | void {\n    const e = event as InputEvent;\n    if (this.args.onInput && this.args.onInput(e) === false) {\n      return false;\n    }\n\n    this.args.select.actions.open(e);\n  }\n\n  @action\n  handleBlur(event: Event) {\n    if (!this._lastIsOpen && this.args.searchFieldPosition === 'trigger') {\n      this.args.select.actions?.search('');\n    }\n\n    if (this.args.onBlur) {\n      this.args.onBlur(event as FocusEvent);\n    }\n  }\n\n  @action\n  handleFocus(event: Event) {\n    if (this.args.onFocus) {\n      this.args.onFocus(event as FocusEvent);\n    }\n  }\n\n  setupInput = modifier(\n    (el: HTMLElement) => {\n      if (this.didSetup) {\n        return;\n      }\n\n      this.didSetup = true;\n\n      if (\n        this.args.searchFieldPosition === undefined ||\n        this.args.searchFieldPosition === 'before-options'\n      ) {\n        this._focusInput(el);\n      }\n\n      return () => {\n        // We don't need to reset search value, when searchFieldPosition is trigger, because complete power select will be destroyed\n        if (this.args.searchFieldPosition === 'trigger') {\n          return;\n        }\n\n        this.args.select.actions?.search('');\n      };\n    },\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    { eager: false },\n  );\n\n  openChange = modifier((element: HTMLElement, [isOpen]: [boolean]) => {\n    this._openChanged(element, [isOpen]);\n  });\n\n  private _openChanged(element: HTMLElement, [isOpen]: [boolean]) {\n    if (\n      isOpen === false &&\n      this._lastIsOpen === true &&\n      document.activeElement !== element\n    ) {\n      void Promise.resolve().then(() => {\n        this.args.select.actions?.search('');\n      });\n    }\n    this._lastIsOpen = isOpen;\n  }\n\n  private _focusInput(el: HTMLElement) {\n    void this.focusLaterTask.perform(el);\n  }\n\n  private focusLaterTask = task(async (el: HTMLElement) => {\n    await timeout(0);\n    if (this.args.autofocus !== false) {\n      el.focus();\n    }\n  });\n\n  <template>\n    <div class=\"ember-power-select-input\">\n      {{! template-lint-disable require-input-label }}\n      {{! template-lint-disable no-positive-tabindex }}\n      {{! template-lint-disable require-aria-activedescendant-tabindex }}\n      <input\n        type=\"search\"\n        autocomplete=\"off\"\n        autocorrect=\"off\"\n        autocapitalize=\"off\"\n        spellcheck={{false}}\n        class={{if\n          @select.multiple\n          \"ember-power-select-trigger-multiple-input\"\n          \"ember-power-select-search-input-field\"\n        }}\n        value={{@select.searchText}}\n        role={{or @role \"combobox\"}}\n        aria-activedescendant={{if @select.isOpen @ariaActiveDescendant}}\n        aria-controls={{if @select.isOpen @listboxId}}\n        aria-owns={{if @select.isOpen @listboxId}}\n        aria-autocomplete=\"list\"\n        aria-haspopup=\"listbox\"\n        aria-expanded={{if @select.isOpen \"true\" \"false\"}}\n        placeholder={{this.placeholder}}\n        aria-label={{@ariaLabel}}\n        aria-labelledby={{@ariaLabelledBy}}\n        aria-describedby={{@ariaDescribedBy}}\n        disabled={{@select.disabled}}\n        tabindex={{@tabindex}}\n        form=\"power-select-fake-form\"\n        id=\"ember-power-select-trigger-input-{{@select.uniqueId}}\"\n        {{on \"input\" this.handleInput}}\n        {{on \"focus\" this.handleFocus}}\n        {{on \"blur\" this.handleBlur}}\n        {{on \"keydown\" this.handleKeydown}}\n        {{this.setupInput}}\n        {{this.openChange @select.isOpen}}\n        ...attributes\n      />\n    </div>\n  </template>\n}\n"],"names":["PowerSelectInput","Component","didSetup","_lastIsOpen","args","select","isOpen","placeholder","isDefaultPlaceholder","undefined","multiple","selected","Array","isArray","length","searchPlaceholder","handleKeydown","e","target","onKeydown","stopPropagation","key","value","trim","buildSelection","lastSelection","actions","search","assert","searchField","get","open","test","close","n","prototype","action","handleInput","event","onInput","handleBlur","searchFieldPosition","onBlur","handleFocus","onFocus","setupInput","modifier","el","_focusInput","eager","openChange","element","_openChanged","document","activeElement","Promise","resolve","then","focusLaterTask","perform","_buildTask","context","generator","timeout","autofocus","focus","setComponentTemplate","precompileTemplate","strictMode","scope","or","on"],"mappings":"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"}